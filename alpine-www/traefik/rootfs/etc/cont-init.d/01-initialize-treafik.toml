#!/bin/execlineb -P

foreground {
 if -t { s6-test ! -d /etc/traefik/config }
 if { s6-echo "[i] Create config folder" } 
 if { s6-mkdir /etc/traefik/config }
}

foreground {
 if -t { s6-test ! -f /etc/traefik/config/rules.toml }
 if { touch /etc/traefik/config/rules.toml }
 if { s6-chmod 4755 /etc/traefik/config/rules.toml }
 if { s6-envuidgid traefik s6-chown -U -- /etc/traefik/config/rules.toml }
}

if -t { s6-test ! -f /etc/traefik/config/traefik.toml }
if { s6-echo "[i] Create config (traefik.toml)" }
if { apk -U add curl }
if { curl -o /etc/traefik/config/traefik.toml -L https://raw.githubusercontent.com/containous/traefik/master/traefik.sample.toml }
if { sed -i "s*# logLevel = \"DEBUG\"*logLevel = \"DEBUG\"*g" /etc/traefik/config/traefik.toml }
if { sed -i "s*# filePath = \"log/traefik.log\"*filePath = \"/var/log/traefik/traefik.log\"*g" /etc/traefik/config/traefik.toml }
if { sed -i "s*# dashboard = false*dashboard = true*g" /etc/traefik/config/traefik.toml }
if { echo "filename = \"/etc/traefik/config/rules.toml\"" >> /etc/traefik/config/traefik.toml }
if { sed -i "s*# domain = \"docker.localhost\"*domain = \"docker.localhost\"*g" /etc/traefik/config/traefik.toml }
if { s6-chmod 4755 /etc/traefik/config/traefik.toml }
if { s6-envuidgid traefik s6-chown -U -- /etc/traefik/config/traefik.toml }
if { apk del curl }
if { s6-rmrf /var/cache/apk/*  /usr/share/doc /usr/share/man/ /usr/share/info/* /var/cache/man/* /var/tmp/* }

foreground {
 if -t { s6-test ! -d /var/log/traefik }
 if { s6-mkdir /var/log/traefik }
}

foreground {
 if -t { s6-test -f /var/log/traefik/traefik.log }
 if { s6-rmrf /var/log/traefik/traefik.log }
}

foreground {
 if -t { s6-test ! -f /var/log/traefik/traefik.log }
 if { ln -s /dev/stdout /var/log/traefik/traefik.log }
}

exit 0
