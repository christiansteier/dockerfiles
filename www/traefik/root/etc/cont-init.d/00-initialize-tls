#!/bin/execlineb -P

foreground {
 if -t { s6-test ! -d /config/traefik/tls }
 if { s6-echo "[i] Create tls folder" }
 if { s6-mkdir -p /config/traefik/tls }
}

if -t { s6-test ! -f /config/traefik/tls/traefik.pem }
if { s6-echo "[i] Create a server certificate" }
if { apk -U add openssl }
if { export RANDFILE /dev/null openssl genrsa -out /config/traefik/tls/traefik.pem 4096 }
if { openssl req -new -x509 -days 3650 -key /config/traefik/tls/traefik.pem -out /config/traefik/tls/traefik.crt -subj "/C=US/CN=0.0.0.0" }
if { s6-envuidgid abc s6-chown -U -- /config/traefik/tls/traefik.pem }
if { s6-envuidgid abc s6-chown -U -- /config/traefik/tls/traefik.crt }
if { apk del openssl }
if { s6-rmrf /var/cache/apk/*  /usr/share/doc /usr/share/man/ /usr/share/info/* /var/cache/man/* /var/tmp }

